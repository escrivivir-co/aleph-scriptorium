asyncapi: 3.0.0
info:
  title: PrologEditor MQTT API
  version: 1.0.0
  description: |
    AsyncAPI specification for PrologEditor's real-time IoT telemetry.
    
    Uses MQTT protocol for:
    - Subscribing to sensor data (temperature, humidity)
    - Publishing commands and alerts
    
    ## Connection
    
    The backend connects to an MQTT broker and subscribes to sensor topics.
    Frontend can connect via MQTT over WebSocket for real-time updates.
  contact:
    name: Aleph Scriptorium
    url: https://escrivivir-co.github.io/aleph-scriptorium/
  license:
    name: AIPL v1.0
    url: https://github.com/escrivivir-co/aleph-scriptorium/blob/main/LICENSE.md

servers:
  mosquitto:
    host: localhost:1883
    protocol: mqtt
    description: Local Mosquitto MQTT broker
    security:
      - $ref: '#/components/securitySchemes/mqttBasic'
  
  websocket:
    host: localhost:9001
    protocol: ws
    description: MQTT over WebSocket (for browser clients)
    security:
      - $ref: '#/components/securitySchemes/mqttBasic'

defaultContentType: application/json

channels:
  sensorTemperature:
    address: sensor/temperature
    description: Temperature sensor readings
    messages:
      temperatureReading:
        $ref: '#/components/messages/SensorReading'
    servers:
      - $ref: '#/servers/mosquitto'
      - $ref: '#/servers/websocket'

  sensorHumidity:
    address: sensor/humidity
    description: Humidity sensor readings
    messages:
      humidityReading:
        $ref: '#/components/messages/SensorReading'
    servers:
      - $ref: '#/servers/mosquitto'
      - $ref: '#/servers/websocket'

  sensorGeneric:
    address: sensor/{sensorType}
    description: Generic sensor channel with dynamic topic
    parameters:
      sensorType:
        description: Type of sensor (temperature, humidity, pressure, etc.)
    messages:
      genericReading:
        $ref: '#/components/messages/SensorReading'

  alerts:
    address: alerts/{severity}
    description: System alerts published by the Prolog engine
    parameters:
      severity:
        description: Alert severity level
        enum:
          - info
          - warning
          - critical
    messages:
      alert:
        $ref: '#/components/messages/Alert'

  commands:
    address: commands/{deviceId}
    description: Commands sent to IoT devices
    parameters:
      deviceId:
        description: Target device identifier
    messages:
      command:
        $ref: '#/components/messages/DeviceCommand'

operations:
  onTemperatureReading:
    action: receive
    channel:
      $ref: '#/channels/sensorTemperature'
    summary: Receive temperature readings
    description: |
      Backend subscribes to temperature sensor data.
      Data is converted to Prolog facts and rules are applied.
    messages:
      - $ref: '#/channels/sensorTemperature/messages/temperatureReading'

  onHumidityReading:
    action: receive
    channel:
      $ref: '#/channels/sensorHumidity'
    summary: Receive humidity readings
    description: |
      Backend subscribes to humidity sensor data.
      Data is converted to Prolog facts and rules are applied.
    messages:
      - $ref: '#/channels/sensorHumidity/messages/humidityReading'

  publishAlert:
    action: send
    channel:
      $ref: '#/channels/alerts'
    summary: Publish system alerts
    description: |
      When Prolog rules trigger alerts, they are published to this channel.
    messages:
      - $ref: '#/channels/alerts/messages/alert'

  sendCommand:
    action: send
    channel:
      $ref: '#/channels/commands'
    summary: Send device commands
    description: |
      Commands generated by Prolog rules are sent to target devices.
    messages:
      - $ref: '#/channels/commands/messages/command'

components:
  messages:
    SensorReading:
      name: SensorReading
      title: Sensor Reading
      summary: IoT sensor data reading
      contentType: application/json
      payload:
        $ref: '#/components/schemas/SensorData'
      examples:
        - name: temperatureExample
          summary: Temperature reading from living room
          payload:
            sensor: temp_living_room
            value: 23.5
            unit: celsius
            timestamp: '2026-01-02T10:30:00Z'
        - name: humidityExample
          summary: Humidity reading
          payload:
            sensor: humidity_bathroom
            value: 75
            unit: percent
            timestamp: '2026-01-02T10:30:00Z'

    Alert:
      name: Alert
      title: System Alert
      summary: Alert generated by Prolog rule evaluation
      contentType: application/json
      payload:
        $ref: '#/components/schemas/AlertData'
      examples:
        - name: highTempAlert
          summary: High temperature warning
          payload:
            alertId: alert_001
            type: temperature_high
            message: Temperature exceeds threshold
            sensor: temp_living_room
            value: 35.2
            threshold: 30
            severity: warning
            timestamp: '2026-01-02T10:31:00Z'

    DeviceCommand:
      name: DeviceCommand
      title: Device Command
      summary: Command to control IoT device
      contentType: application/json
      payload:
        $ref: '#/components/schemas/CommandData'
      examples:
        - name: turnOnAC
          summary: Turn on air conditioning
          payload:
            commandId: cmd_001
            action: turn_on
            device: ac_living_room
            parameters:
              targetTemp: 22
            timestamp: '2026-01-02T10:31:05Z'

  schemas:
    SensorData:
      type: object
      description: Sensor reading data
      properties:
        sensor:
          type: string
          description: Unique sensor identifier
        value:
          oneOf:
            - type: number
            - type: string
            - type: boolean
          description: Sensor value
        unit:
          type: string
          description: Measurement unit
        timestamp:
          type: string
          format: date-time
          description: Reading timestamp
        metadata:
          type: object
          additionalProperties: true
          description: Additional sensor metadata
      required:
        - sensor
        - value

    AlertData:
      type: object
      description: Alert information
      properties:
        alertId:
          type: string
          description: Unique alert identifier
        type:
          type: string
          description: Alert type/category
        message:
          type: string
          description: Human-readable alert message
        sensor:
          type: string
          description: Related sensor
        value:
          oneOf:
            - type: number
            - type: string
          description: Value that triggered the alert
        threshold:
          type: number
          description: Threshold that was exceeded
        severity:
          type: string
          enum:
            - info
            - warning
            - critical
          description: Alert severity level
        timestamp:
          type: string
          format: date-time
          description: Alert timestamp
      required:
        - alertId
        - type
        - message
        - severity

    CommandData:
      type: object
      description: Device command data
      properties:
        commandId:
          type: string
          description: Unique command identifier
        action:
          type: string
          description: Action to perform
        device:
          type: string
          description: Target device identifier
        parameters:
          type: object
          additionalProperties: true
          description: Action-specific parameters
        timestamp:
          type: string
          format: date-time
          description: Command timestamp
      required:
        - commandId
        - action
        - device

  securitySchemes:
    mqttBasic:
      type: userPassword
      description: MQTT broker authentication
