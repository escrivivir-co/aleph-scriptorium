<!DOCTYPE html>
<html lang="{{ site.lang | default: 'es' }}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ page.titulo }} | Teatro | {{ site.title }}</title>
  <meta name="description" content="{{ page.descripcion | strip_html | truncate: 160 }}">
  
  <!-- Teatro Styles -->
  <link rel="stylesheet" href="{{ '/assets/css/teatro.css' | relative_url }}">
  
  {% seo %}
</head>
<body class="impress-not-supported">
  
  <!-- Fallback para navegadores sin soporte -->
  <div class="fallback-message">
    <p>Tu navegador <b>no soporta las caracter√≠sticas</b> necesarias para esta presentaci√≥n.</p>
    <p>Por favor, usa <b>Chrome</b>, <b>Firefox</b> o <b>Safari</b> actualizado.</p>
  </div>

  <!-- Canvas de Impress.js -->
  <div id="impress" 
       data-transition-duration="1000"
       data-width="1920"
       data-height="1080"
       data-max-scale="3"
       data-min-scale="0.5">
    
    <!-- Paso de inicio (Overview) -->
    <div id="overview" class="step" 
         data-x="0" 
         data-y="0" 
         data-z="3000" 
         data-scale="10">
      <h1>{{ page.titulo }}</h1>
      <blockquote>{{ page.descripcion }}</blockquote>
      <p><small>Presiona <kbd>Espacio</kbd> o <kbd>‚Üí</kbd> para comenzar</small></p>
    </div>

    {% comment %}
    Generar pasos desde las escenas definidas en el frontmatter.
    Cada escena se convierte en un "step" de impress.js.
    
    Sistema de coordenadas:
    - Anillo 0: Centro (0,0)
    - Anillo 1: Radio 1000px, estadios 1-4 distribuidos a 90¬∞ cada uno
    - Anillo 2: Radio 2000px, estadios 5-8 distribuidos a 90¬∞ cada uno
    - Anillo 3: Radio 3000px, estadios 9-12 distribuidos a 90¬∞ cada uno
    {% endcomment %}
    
    {% for escena in page.escenas %}
    {% assign step_id = escena.id %}
    {% assign anillo = escena.anillo | default: 1 %}
    
    {% comment %}Calcular radio seg√∫n anillo{% endcomment %}
    {% if anillo == 0 %}
      {% assign radio = 0 %}
      {% assign x = 0 %}
      {% assign y = 0 %}
    {% elsif anillo == 1 %}
      {% assign radio = 1000 %}
      {% assign pos_en_anillo = step_id | minus: 1 %}
      {% comment %}Posiciones: 0=arriba, 1=derecha, 2=abajo, 3=izquierda{% endcomment %}
      {% case pos_en_anillo %}
        {% when 0 %}{% assign x = 0 %}{% assign y = -1000 %}
        {% when 1 %}{% assign x = 1000 %}{% assign y = 0 %}
        {% when 2 %}{% assign x = 0 %}{% assign y = 1000 %}
        {% when 3 %}{% assign x = -1000 %}{% assign y = 0 %}
        {% else %}{% assign x = 1000 %}{% assign y = 0 %}
      {% endcase %}
    {% elsif anillo == 2 %}
      {% assign radio = 2000 %}
      {% assign pos_en_anillo = step_id | minus: 5 %}
      {% case pos_en_anillo %}
        {% when 0 %}{% assign x = 0 %}{% assign y = -2000 %}
        {% when 1 %}{% assign x = 2000 %}{% assign y = 0 %}
        {% when 2 %}{% assign x = 0 %}{% assign y = 2000 %}
        {% when 3 %}{% assign x = -2000 %}{% assign y = 0 %}
        {% else %}{% assign x = 2000 %}{% assign y = 0 %}
      {% endcase %}
    {% else %}
      {% assign radio = 3000 %}
      {% assign pos_en_anillo = step_id | minus: 9 %}
      {% case pos_en_anillo %}
        {% when 0 %}{% assign x = 0 %}{% assign y = -3000 %}
        {% when 1 %}{% assign x = 3000 %}{% assign y = 0 %}
        {% when 2 %}{% assign x = 0 %}{% assign y = 3000 %}
        {% when 3 %}{% assign x = -3000 %}{% assign y = 0 %}
        {% else %}{% assign x = 3000 %}{% assign y = 0 %}
      {% endcase %}
    {% endif %}
    
    {% comment %}Rotaci√≥n basada en posici√≥n para mirar hacia el centro{% endcomment %}
    {% assign angulo = step_id | minus: 1 | times: 30 %}
    
    <div id="step-{{ step_id }}" 
         class="step" 
         data-x="{{ x }}" 
         data-y="{{ y }}" 
         data-z="0"
         data-rotate-z="{{ angulo }}"
         data-ring="{{ anillo }}"
         data-scale="1">
      
      <h2>{{ escena.nombre }}</h2>
      
      {% if escena.contenido_ref %}
        {% comment %}
        Cargar contenido desde _includes/teatro/escenas/
        Usamos capture + markdownify para procesar el Markdown incluido
        {% endcomment %}
        {% capture include_path %}teatro/escenas/{{ page.slug }}/{{ escena.contenido_ref }}{% endcapture %}
        {% capture escena_content %}{% include {{ include_path }} %}{% endcapture %}
        {{ escena_content | markdownify }}
      {% else %}
        <p>{{ escena.descripcion }}</p>
      {% endif %}
      
      {% if escena.prueba %}
      <div class="prueba">
        <h3>üéØ Prueba</h3>
        <p><strong>Tarea:</strong> {{ escena.prueba.tarea }}</p>
        <p><strong>√âxito:</strong> {{ escena.prueba.exito }}</p>
      </div>
      {% endif %}
      
      <!-- Navegaci√≥n prev/next -->
      <nav class="step-nav">
        {% assign prev_id = step_id | minus: 1 %}
        {% assign next_id = step_id | plus: 1 %}
        {% if prev_id >= 1 %}
          <a href="#step-{{ prev_id }}" class="nav-prev" title="Anterior">‚Üê Anterior</a>
        {% else %}
          <a href="#overview" class="nav-prev" title="Inicio">‚Üê Inicio</a>
        {% endif %}
        <span class="nav-progress">{{ step_id }} / {{ page.escenas | size }}</span>
        {% if next_id <= page.escenas.size %}
          <a href="#step-{{ next_id }}" class="nav-next" title="Siguiente">Siguiente ‚Üí</a>
        {% else %}
          <a href="#step-final" class="nav-next" title="Fin">Fin ‚Üí</a>
        {% endif %}
      </nav>
      
      <div class="meta">
        <span class="badge">Anillo {{ anillo }}</span>
        <span class="badge">{{ escena.tipo }}</span>
      </div>
    </div>
    {% endfor %}
    
    <!-- Paso final -->
    <div id="step-final" class="step" 
         data-x="0" 
         data-y="0" 
         data-z="1000" 
         data-scale="5">
      <h1>Fin</h1>
      <p>Presiona <kbd>O</kbd> para volver al resumen general.</p>
      <p><a href="{{ '/teatro' | relative_url }}">‚Üê Volver a la cartelera</a></p>
    </div>
  </div>

  <!-- UI de controles -->
  <div id="theater-ui">
    <label for="ring-slider">Anillo:</label>
    <input type="range" id="ring-slider" min="0" max="3" value="0" step="1">
    <span id="ring-label">0</span>
  </div>

  <!-- Volver a cartelera -->
  <div class="back-to-cartelera">
    <a href="{{ '/teatro' | relative_url }}">‚Üê Cartelera</a>
  </div>

  <!-- √çndice lateral (√°rbol de navegaci√≥n) -->
  <nav class="theater-index">
    <h3>√çndice</h3>
    <ul>
      <li><a href="#overview">üé≠ Inicio</a></li>
      {% for escena in page.escenas %}
      <li data-step="step-{{ escena.id }}"><a href="#step-{{ escena.id }}">{{ escena.id }}. {{ escena.nombre }}</a></li>
      {% endfor %}
      <li><a href="#step-final">üé¨ Fin</a></li>
    </ul>
  </nav>

  <!-- Bot√≥n de ayuda -->
  <button class="help-toggle" title="Ayuda de navegaci√≥n">?</button>

  <!-- Help Overlay -->
  <div class="help-overlay" id="help-overlay">
    <div class="help-content">
      <h2>üé≠ Navegaci√≥n del Teatro</h2>
      <table>
        <tr><td><kbd>‚Üí</kbd> <kbd>Espacio</kbd></td><td>Siguiente diapositiva</td></tr>
        <tr><td><kbd>‚Üê</kbd></td><td>Diapositiva anterior</td></tr>
        <tr><td><kbd>‚Üë</kbd> <kbd>‚Üì</kbd></td><td>Cambiar de anillo</td></tr>
        <tr><td><kbd>O</kbd></td><td>Vista general (overview)</td></tr>
        <tr><td><kbd>Esc</kbd></td><td>Cerrar ayuda</td></tr>
      </table>
      <p style="margin-top: 20px; color: #888; font-size: 14px;">
        Usa el <strong>slider de anillos</strong> en la parte inferior para navegar entre niveles del monomito.
      </p>
      <div class="help-close">
        <button onclick="document.getElementById('help-overlay').classList.remove('active')">Entendido</button>
      </div>
    </div>
  </div>

  <!-- Scripts: impress.js debe cargarse antes de teatro.js -->
  <script src="{{ '/assets/js/impress.js' | relative_url }}"></script>
  <script src="{{ '/assets/js/teatro.js' | relative_url }}"></script>
  <script>
    // Toggle help overlay
    document.querySelector('.help-toggle').addEventListener('click', function() {
      document.getElementById('help-overlay').classList.add('active');
    });
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        document.getElementById('help-overlay').classList.remove('active');
      }
    });
  </script>
</body>
</html>
